<!DOCTYPE html><html><head><title>Draw</title><meta charset="UTF-8" /><script src="draw.js"></script>
<style> body{ margin: 0; } .container { font-family: sans-serif; text-align: center; }
.excalidraw-wrapper { height: 100vh;  width: 100vw; margin: 0;  position: relative; }
</style></head>
<body><div class="container"><div id="app"></div></div><script>

function get(id, onload)
{
	var x = new XMLHttpRequest();
	x.open("GET", "http://localhost:4040/api/get?id="+id);
	x.send();
	x.onload = function()
	{
		onload(x.responseText);
	};
}

function save(data, raster, onload)
{
	var x = new XMLHttpRequest();
	x.open("POST", "http://localhost:4040/api/update");

	var body = 
	{
		"id": localStorage.getItem("current-drawing"),
		"data": JSON.stringify(data),
		"raster": raster
	};

	x.send(JSON.stringify(body));
	x.onload = onload;
}

function bin_to_hex(bin)
{
	var hex = "";
	for (var i=0;i<bin.length;i++)
	{
		var b = bin[i];
		var number = (b).toString(16).toUpperCase();
		if( (number.length % 2) > 0 )
			number = "0" + number;
		hex += number;
	}
	return hex;
}


function crop(c)
{
	var PADDING = 10;
	var ctx = canvas.getContext("2d")
	var data = ctx.getImageData(0,0,c.width, c.height).data;
	var start = 0;

	var minx = 99999;
	var miny = 99999;
	var maxx = 0;
	var maxy = 0;
	for (var i=0;i<data.length/4;i++)
	{
		var r = data[i*4+0];
		var g = data[i*4+1];
		var b = data[i*4+2];
		var x =i % c.width;
		var y = Math.floor(i / c.width);

		if (r != 255 && g != 255 && b != 255)
		{
			if (x < minx) minx = x;
			if (y < miny) miny = y;

			if (x > maxx) maxx = x;
			if (y > maxy) maxy = y;

		}
	}

	minx = minx - PADDING;
	miny = miny - PADDING;
	maxx = maxx + PADDING;
	maxy = maxy + PADDING;

	if (minx < 0)	minx = 0;
	if (miny < 0)	miny = 0;
	if (maxx > c.width)	maxx = c.width;
	if (maxy > c.height)	maxy = c.height;

	var dx = maxx - minx;
	var dy = maxy - miny;

	var out = document.createElement("canvas")
	out.width = dx;
	out.height = dy;
	var out_ctx = out.getContext("2d")

	out_ctx.drawImage(c, minx, miny, dx, dy, 0, 0, dx, dy);
	console.log(dx, dy);
	console.log(minx, miny, maxx, maxy);
	return out;
}

function hex_to_bin(hex)
{
	var bin = new Uint8Array(hex.length / 2);
	for (var i=0;i<hex.length/2;i++)
	{
		var h = hex[i*2] + hex[i*2+1];
		bin[i] = parseInt(h, 16);
	}
	return bin;
}

const App = () =>
{
	const excalidrawRef = React.useRef(null);
	const excalidrawWrapperRef = React.useRef(null);
	const [dimensions, setDimensions] = React.useState({
		width: undefined,
		height: undefined
	});

	React.useEffect(() => 
	{
		setDimensions({
			width: excalidrawWrapperRef.current.getBoundingClientRect().width,
			height: excalidrawWrapperRef.current.getBoundingClientRect().height
		});

		var id = localStorage.getItem("current-drawing");
		if (id == null)
			return;

		get(id, function(data, err)
		{
			data = JSON.parse(data);
			data.collaborators = new Map();
			data.appState.width = 1920;
			data.appState.height = 1080;
			updateScene(data);
		});

		const onResize = () =>
		{
			setDimensions({
				width: excalidrawWrapperRef.current.getBoundingClientRect().width,
				height: excalidrawWrapperRef.current.getBoundingClientRect().height
			});
		};

		window.addEventListener("keydown", function(e)
		{
			// ctrl-s
			if (e.keyCode == 83 && (navigator.platform.match("Mac") ? e.metaKey : e.ctrlKey))
			{
				var elements = excalidrawRef.current.getSceneElements();
				var app = excalidrawRef.current.getAppState();
				var canvas = document.getElementById("canvas");
				canvas = crop(canvas);
				canvas.toBlob(function(blob)
				{
					blob.arrayBuffer().then(function(buffer)
					{
						var raster = bin_to_hex(new Uint8Array(buffer))
						save({"elements":elements, "appState": app}, raster, function()
						{
							console.log("saved");
						})
					});
				}, "image/png");


				e.stopPropagation();
				e.preventDefault();
				return false;
			}
		})
		window.addEventListener("resize", onResize);
		return () => window.removeEventListener("resize", onResize);
	}, [excalidrawWrapperRef]);

	const updateScene = (data) =>
	{
		excalidrawRef.current.updateScene(data);
	};

	return React.createElement(React.Fragment, null,
		React.createElement("div",
		{
			className: "excalidraw-wrapper",
			ref: excalidrawWrapperRef
		},
		React.createElement(Excalidraw.default, {
			ref: excalidrawRef,
			width: dimensions.width,
			height: dimensions.height
		})
		)
	);
};

const excalidrawWrapper = document.getElementById("app");
ReactDOM.render(React.createElement(App), excalidrawWrapper);

</script></body></html>